---
title: JVM栈帧
date: 2023-05-09 01:52:51 
summary: 本文分享JVM栈帧的相关内容。
tags:
- Java
- JVM
categories:
- Java
---

# 帧

每个Java虚拟机线程都有一个私有的Java虚拟机堆栈，与线程同时创建。Java虚拟机堆栈存储帧。

推荐阅读：[JVM运行时数据区域](https://blankspace.blog.csdn.net/article/details/130567913)

每个帧包含一个称为局部变量的变量数组。帧的局部变量数组的长度在编译时确定，并在二进制表示的类或接口中与与帧关联的方法的代码一起提供。

单个局部变量可以保存布尔、字节、字符、短整型、整型、浮点型、引用或returnAddress类型的值。一对局部变量可以保存长整型或双精度浮点型的值。

推荐阅读：[JVM数据类型](https://blankspace.blog.csdn.net/article/details/130568656)

局部变量通过索引进行寻址。第一个局部变量的索引为零。当且仅当整数位于局部变量数组的大小之间时，整数才被视为局部变量数组的索引。

类型为长整型或双精度浮点型的值占用两个连续的局部变量。这样的值只能使用较小的索引进行寻址。例如，存储在索引n处的双精度值实际上占用具有索引n和n+1的局部变量；但是，不能从索引n+1处加载局部变量。可以存储到n+1的位置。但是，这样做会使局部变量n的内容失效。

Java虚拟机不要求n是偶数。直观地讲，长整型和双精度浮点型的值在局部变量数组中不必是64位对齐的。实现者可以自由地决定使用保留给该值的两个局部变量来表示这种值的适当方式。

Java虚拟机使用局部变量在方法调用时传递参数。在类方法调用时，任何参数都从局部变量0开始传递。在实例方法调用时，局部变量0始终用于传递对正在调用实例方法的对象的引用（在Java编程语言中为this）。然后从局部变量1开始连续传递任何参数。

## 本地变量

每个帧都包含一个变量数组，称为它的本地变量。帧的本地变量数组的长度在编译时确定，并随着与帧相关联的方法的代码一起在类或接口的二进制表示中提供。

一个单独的本地变量可以保存布尔型、字节型、字符型、短整型、整型、浮点型、引用型或 returnAddress。一对本地变量可以保存长整型或双精度浮点型。

本地变量通过索引进行寻址。第一个本地变量的索引为零。只有当整数介于零和本地变量数组大小减一之间时，整数才被视为本地变量数组的索引。

长整型或双精度浮点型的值占用两个连续的本地变量。这样的值只能使用较小的索引进行寻址。例如，存储在本地变量数组中索引为n的双精度浮点型的值实际上占用具有索引n和n+1的本地变量；但是，索引为n+1的本地变量不能被加载。它可以被存储。但是，这样做会使本地变量n的内容无效。

Java虚拟机不要求n是偶数。直观地说，类型为long和double的值不需要在本地变量数组中对齐64位。实现者可以自由决定使用为该值保留的两个本地变量来表示这样的值的适当方式。

Java虚拟机使用本地变量在方法调用时传递参数。在类方法调用中，任何参数都是按顺序传递的，从本地变量0开始。在实例方法调用中，本地变量0始终用于传递对正在调用实例方法的对象的引用（在Java编程语言中为this）。任何参数随后在连续的本地变量中传递，从本地变量1开始。

## 操作数栈

每个帧都包含一个后进先出（LIFO）栈，称为其操作数栈。帧的操作数栈的最大深度在编译时确定，并与与帧关联的方法的代码一起提供。

在上下文清楚的情况下，我们有时会将当前帧的操作数栈简称为操作数栈。

操作数栈在包含它的帧创建时为空。Java虚拟机提供了指令，用于将常量或值从局部变量或字段加载到操作数栈上。其他Java虚拟机指令从操作数栈中取操作数，对它们进行操作，并将结果推回操作数栈。操作数栈也用于准备要传递给方法的参数并接收方法的结果。

例如，iadd指令将两个int值相加。它要求要相加的int值是操作数栈的前两个值，这些值由先前的指令推到栈顶。两个int值都从操作数栈中弹出。它们相加，它们的和被推回到操作数栈中。子计算可以嵌套在操作数栈上，导致可以由包围计算使用的值。

操作数栈上的每个条目都可以保存任何Java虚拟机类型的值，包括类型为long或double的值。

必须以适合操作数栈中的值类型的方式操作它们。例如，不可能push两个int值，然后将它们视为一个long值，也不可能push两个float值，然后使用iadd指令将它们相加。少量Java虚拟机指令（dup指令和swap指令）作为原始值对运行时数据区进行操作，而不考虑它们的特定类型。这些指令的定义方式使它们无法用于修改或拆分单个值。操作数栈操纵的这些限制是通过类文件验证强制执行的。

在任何时刻，操作数栈都有一个相关的深度，其中类型为long或double的值对深度贡献两个单位，而任何其他类型的值则贡献一个单位。

## 动态链接

每个帧都包含一个对当前方法类型的运行时常量池的引用，以支持方法代码的动态链接。方法的类文件代码通过符号引用引用要调用的方法和要访问的变量。动态链接将这些符号方法引用转换为具体的方法引用，必要时加载类以解析未定义的符号，并将变量访问转换为与这些变量的运行时位置相关联的存储结构中的适当偏移量。

这种方法和变量的后期绑定使得对方法使用的其他类的更改不太可能破坏此代码。

## 正常方法调用完成

如果方法调用不会导致异常直接从Java虚拟机抛出或作为执行显式throw语句的结果抛出，则该方法调用正常完成。如果当前方法的调用正常完成，则可以向调用方法返回值。当被调用的方法执行return指令之一时，将返回值（如果有）push到调用帧的操作数栈上，必须选择适当的return指令来返回值（如果有）。

在这种情况下，使用当前帧来恢复调用者的状态，包括其本地变量和操作数栈，并适当增加调用者的程序计数器，以跳过方法调用指令。然后，在调用方法的帧中正常执行，并将返回值（如果有）push到该帧的操作数栈上。

## 突然方法调用完成

如果方法内部的Java虚拟机指令的执行导致Java虚拟机抛出异常，并且该异常未在方法内部处理，则方法调用突然完成。执行athrow指令也会导致异常被显式抛出，如果当前方法没有捕获该异常，则会导致方法调用突然完成。突然完成的方法调用从不向其调用者返回值。
