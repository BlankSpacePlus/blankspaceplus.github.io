---
title: 迭代器遍历集合
date: 2023-02-06 21:31:22
summary: 本文分享Java、C++、Python迭代器遍历集合的方法，引申出迭代器模式。
tags:
- 程序设计
categories:
- 程序设计
---

# Java迭代器

java.util.Iterator隐藏了Collection实现类的底层细节，向应用程序提供了遍历Collection集合元素的统一编程接口。

java.util.Iterator接口定义的四个方法：
- `boolean hasNext()`：判断当前迭代器是否将集合遍历完。
- `Object next()`：返回集合待遍历的下一个元素。
- `void remove()`：删除集合里上一次next()返回的元素。
- `void forEachRemaining(Consumer action)`：支持通过Lambda表达式遍历集合元素。

迭代器只负责遍历集合，本身不作为容器存在。想要被Iterator遍历的集合必须有可被迭代遍历。Iterator必须依附于Collection存在，Java以集合的内部类的形式实现迭代器。

迭代器遍历集合元素时，集合元素不能改变，只能通过迭代器的remove()方法删除上一次next()返回的集合元素，否则将抛出`java.util.ConcurrentModificationException`异常（采用fail-fast机制）。

```java
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;

public class IteratorTest {
    public static void main(String[] args) {
        // 创建一个集合
        Collection books = new HashSet();
        books.add("高等数学");
        books.add("线性代数");
        books.add("离散数学");
        // 获取books集合对应的迭代器
        Iterator it = books.iterator();
        while (it.hasNext()) {
            // it.next()方法返回的数据类型是Object类型，因此需要强制类型装换
            String book = (String) it.next();
            System.out.println(book);
            if (book.contentEquals("高等数学")) {
                // 从集合中删除上一次next()方法返回的元素
                it.remove();
            }
            // 对book变量赋值，不会改变集合元素本身
            book = "测试字符串";
        }
        System.out.println(books);
    }
}
```

迭代器遍历集合的过程也可以通过foreach语法糖简化。

# C++迭代器

C++的STL集合同样采用迭代器遍历。

vector遍历：
```cpp
vector<int>::iterator it = vec.begin();
while(it != vec.end()) {
    cout << "value of v = " << *it << endl;
    it++;
}
```

map遍历：
```cpp
for (it = mp.begin(); it != mp.end(); it++) {
    cout << it.first << " " << it.second << endl;
}
```

# Python迭代器

iter()和next()是Python的内置函数，它们可以用于迭代可迭代对象中的元素。

iter()函数用于获取一个可迭代对象的迭代器，如果对象本身就是迭代器，则返回对象本身。iter()函数接受一个可迭代对象作为参数，返回该对象的迭代器。
```python
my_list = [1, 2, 3]
my_iter = iter(my_list)
```

next()函数用于获取迭代器中的下一个元素。next()函数接受一个迭代器作为参数，返回该迭代器的下一个元素。当没有更多元素时，会抛出StopIteration异常。
```python
my_list = [1, 2, 3]
my_iter = iter(my_list)
print(next(my_iter))  # 输出：1
print(next(my_iter))  # 输出：2
print(next(my_iter))  # 输出：3
print(next(my_iter))  # 抛出StopIteration异常
```

除了手动调用next()函数，我们还可以使用for...in循环遍历迭代器对象，这样可以避免抛出StopIteration异常。
```python
lst = [1, 2, 3]
it = iter(lst)  # 获取一个迭代器对象
for x in it:
    print(x)  # 输出1、2、3
```

对于一些不支持迭代器的对象，例如整数和字符串，我们需要使用iter()函数将其转换为可迭代对象才能使用迭代器进行遍历。

在Python中，要创建一个迭代器，需要定义一个包含`__iter__()`和`__next__()`方法的对象。这些方法允许我们遍历对象中的元素。

`__iter__()`方法返回迭代器对象本身。当我们使用一个迭代器时，首先会调用该方法。

`__next__()`方法返回迭代器中下一个元素。在每次迭代时，Python都会调用该方法。如果没有下一个元素可供返回，则`__next__()`方法应该引发StopIteration异常。

下面是一个简单的例子，使用一个迭代器来遍历一个列表中的元素：
```python
class MyListIterator:
    def __init__(self, my_list):
        self.index = 0
        self.my_list = my_list

    def __iter__(self):
        return self

    def __next__(self):
        if self.index >= len(self.my_list):
            raise StopIteration
        value = self.my_list[self.index]
        self.index += 1
        return value


my_list = [1, 2, 3]
my_list_iterator = MyListIterator(my_list)
for item in my_list_iterator:
    print(item)
```

在这个例子中，我们定义了一个名为 MyListIterator 的迭代器类。该类包含`__iter__()`和`__next__()`方法。`__iter__()`方法返回迭代器对象本身，而`__next__()`方法遍历列表中的元素。在主程序中，我们创建了一个 MyListIterator 对象并使用 for 循环遍历列表中的元素。

通过自定义迭代器，我们可以控制元素的生成方式，使其能够按照我们的期望方式进行迭代。

# 迭代器模式

迭代器模式用于在数据集合中按顺序遍历集合，可以将遍历与实现分离开。

例如：
```java
Iterator<OrderItem> iterator = order.getIterator();
while (iterator.hasNext()) {
    System.out.println(iterator.getNext())
}
```

在上面的代码片段中，我们获取了Order实例的迭代器对象，并用此对象遍历集合。迭代器对象是从Order实例获取的，但遍历过程不依赖于Order的实现。

下面用一个实例展示迭代器模式的实践方法：

![在这里插入图片描述](https://img-blog.csdnimg.cn/87a5417f1bd045c0b033060de160eade.jpeg)

`OrderItem.java`

```java
public class OrderItem {

    private int orderItemId;

    private String productName;

    public OrderItem(int orderItemId, String productName) {
        this.orderItemId = orderItemId;
        this.productName = productName;
    }

    public int getOrderItemId() {
        return this.orderItemId;
    }

    public String getProductName() {
        return this.productName;
    }

    @Override
    public String toString() {
        return "OrderItem{" +
                "orderItemId=" + orderItemId +
                ", productName='" + productName + '\'' +
                '}';
    }

}
```

`Iterable.java`

```java
public interface Iterable<T> {

    Iterator<T> getIterator();

}
```

`Order.java`

```java
public class Order implements Iterable<OrderItem> {

    private OrderItem[] orderItems;

    private int capacity;

    private int size;

    public Order() {
        this.capacity = 8;
        this.orderItems = new OrderItem[this.capacity];
        this.size = 0;
    }

    public Order(int size) {
        this.orderItems = new OrderItem[size];
        this.capacity = size;
        this.size = 0;
    }

    public Order(OrderItem[] orderItems) {
        this.orderItems = orderItems;
        this.capacity = this.orderItems.length;
        this.size = this.orderItems.length;
    }

    public OrderItem getOrderItem(int index) {
        if (index < this.size) {
            return this.orderItems[index];
        }
        return null;
    }

    public void addOrderItem(OrderItem newOrderItem) {
        if (this.capacity <= this.size) {
            int newCapacity = 2 * this.capacity + 1;
            OrderItem[] newOrderItems = new OrderItem[newCapacity];
            System.arraycopy(this.orderItems, 0, newOrderItems, 0, this.capacity);
            this.capacity = newCapacity;
            this.orderItems = newOrderItems;
        }
        this.orderItems[this.size++] = newOrderItem;
    }

    public int getSize() {
        return this.size;
    }

    @Override
    public Iterator<OrderItem> getIterator() {
        return new OrderIterator(this);
    }

}
```

`Iterator.java`

```java
public interface Iterator<T> {

    boolean hasNext();

    T getNext();

}
```

`OrderIterator.java`

```java
public class OrderIterator implements Iterator<OrderItem> {

    private Order order;

    private int index;

    public OrderIterator(Order order) {
        this.order = order;
    }

    @Override
    public boolean hasNext() {
        return this.index < order.getSize();
    }

    @Override
    public OrderItem getNext() {
        OrderItem item = order.getOrderItem(this.index);
        this.index++;
        return item;
    }

}
```

尽管我们只实现了从前向后顺序遍历的迭代器，但迭代器也可以有多种形式：
- 从后向前倒序遍历
- 双向遍历
- 根据指定下标进行跳跃式遍历

测试脚本：
```java
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

public class OrderIteratorTest {

    private final String orderJsonPattern = "OrderItem{orderItemId=1, productName='咖啡'}\n"
            + "OrderItem{orderItemId=2, productName='方便面'}\n"
            + "OrderItem{orderItemId=3, productName='面包'}\n"
            + "OrderItem{orderItemId=4, productName='橙汁'}\n"
            + "OrderItem{orderItemId=5, productName='巧克力'}\n"
            + "OrderItem{orderItemId=6, productName='火腿肠'}\n"
            + "OrderItem{orderItemId=7, productName='矿泉水'}\n"
            + "OrderItem{orderItemId=8, productName='薯片'}\n"
            + "OrderItem{orderItemId=9, productName='饼干'}\n"
            + "OrderItem{orderItemId=10, productName='爆米花'}\n";

    @Test
    public void iteratorTest1() {
        Order order = new Order();
        order.addOrderItem(new OrderItem(1, "咖啡"));
        order.addOrderItem(new OrderItem(2, "方便面"));
        order.addOrderItem(new OrderItem(3, "面包"));
        order.addOrderItem(new OrderItem(4, "橙汁"));
        order.addOrderItem(new OrderItem(5, "巧克力"));
        order.addOrderItem(new OrderItem(6, "火腿肠"));
        order.addOrderItem(new OrderItem(7, "矿泉水"));
        order.addOrderItem(new OrderItem(8, "薯片"));
        order.addOrderItem(new OrderItem(9, "饼干"));
        order.addOrderItem(new OrderItem(10, "爆米花"));
        Iterator<OrderItem> iterator = order.getIterator();
        StringBuilder result = new StringBuilder();
        while (iterator.hasNext()) {
            result.append(iterator.getNext()).append('\n');
        }
        Assertions.assertEquals(orderJsonPattern, result.toString());
    }

    @Test
    public void iteratorTest2() {
        OrderItem[] orderItems = new OrderItem[] {
                new OrderItem(1, "咖啡"),
                new OrderItem(2, "方便面"),
                new OrderItem(3, "面包"),
                new OrderItem(4, "橙汁"),
                new OrderItem(5, "巧克力"),
                new OrderItem(6, "火腿肠"),
                new OrderItem(7, "矿泉水"),
                new OrderItem(8, "薯片"),
                new OrderItem(9, "饼干"),
                new OrderItem(10, "爆米花")
        };
        Order order = new Order(orderItems);
        Iterator<OrderItem> iterator = order.getIterator();
        StringBuilder result = new StringBuilder();
        while (iterator.hasNext()) {
            result.append(iterator.getNext()).append('\n');
        }
        Assertions.assertEquals(orderJsonPattern, result.toString());
    }

    @Test
    public void iteratorTest3() {
        Order order = new Order(1);
        order.addOrderItem(new OrderItem(1, "咖啡"));
        order.addOrderItem(new OrderItem(2, "方便面"));
        order.addOrderItem(new OrderItem(3, "面包"));
        order.addOrderItem(new OrderItem(4, "橙汁"));
        order.addOrderItem(new OrderItem(5, "巧克力"));
        order.addOrderItem(new OrderItem(6, "火腿肠"));
        order.addOrderItem(new OrderItem(7, "矿泉水"));
        order.addOrderItem(new OrderItem(8, "薯片"));
        order.addOrderItem(new OrderItem(9, "饼干"));
        order.addOrderItem(new OrderItem(10, "爆米花"));
        Iterator<OrderItem> iterator = order.getIterator();
        StringBuilder result = new StringBuilder();
        while (iterator.hasNext()) {
            result.append(iterator.getNext()).append('\n');
        }
        Assertions.assertEquals(orderJsonPattern, result.toString());
    }

}
```

Maven配置：
```xml
<dependencies>
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter-api</artifactId>
        <version>5.9.0</version>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter-engine</artifactId>
        <version>5.9.0</version>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter-params</artifactId>
        <version>5.9.0</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```
