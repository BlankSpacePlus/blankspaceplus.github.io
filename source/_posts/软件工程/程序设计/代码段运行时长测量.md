---
title: 代码段运行时长测量
date: 2020-03-03 15:27:59
summary: 本文分享代码段运行时长的测量方法，以Java、Python、C、C++为例。
tags:
- 程序设计
categories:
- 程序设计
---

# Java代码段运行时间测量

Java中测量代码运行时间的常用方法有以下几种：
1. 使用System.currentTimeMillis()方法：该方法返回自1970年1月1日00:00:00 GMT以来的毫秒数。可以在代码开始前记录时间，执行完代码后再记录时间，计算时间差来获得代码运行时间。
2. 使用System.nanoTime()方法：该方法返回当前时间的纳秒数。可以在代码开始前记录时间，执行完代码后再记录时间，计算时间差来获得代码运行时间。相较于System.currentTimeMillis()方法，System.nanoTime()方法精度更高，但是不保证同步和可用性。
3. 使用java.util.Date类：可以在代码开始前记录时间，执行完代码后再记录时间，计算时间差来获得代码运行时间。这种方法比较灵活，可以按照需要用java.text.SimpleDateFormat类设置时间格式。
4. 使用Java 8中的Instant类：Instant类提供了获取当前时间戳的方法，并且精度高于System.currentTimeMillis()方法。

## java.lang.System.currentTimeMillis()

想要测量Java代码段的运行时间，可以使用System.currentTimeMillis()，获取系统当前时间（按ms计量），类型为long。

在测试代码段开始前打上第一个时间戳，使用System.currentTimeMillis()获取当前时间；在结束部分再打一个时间戳，再次使用System.currentTimeMillis()获取当前时间。

```java
public class PerformanceTimer {
    public static void main(String[] args) {
        // 记录程序开始时间
        long startTime = System.currentTimeMillis();
        // 这里是要测试的代码块
        int sum = 0;
        for (int i = 1; i <= 10000000; i++) {
            sum += i;
        }
        // 记录程序结束时间
        long endTime = System.currentTimeMillis();
        // 计算代码块运行时间
        long duration = endTime - startTime;
        // 输出运行时间
        System.out.println("程序运行时间：" + duration + "毫秒");
    }
}
```

对于上面的代码段：首先，使用 System.currentTimeMillis() 方法记录程序开始时间，然后执行要测试的代码块，最后再记录程序结束时间。计算运行时间时，将结束时间减去开始时间即可得到代码块的运行时间。最后通过输出语句将运行时间输出到控制台。

## java.lang.System.nanoTime()

```java
public class PerformanceTimer {
    public static void main(String[] args) {
        // 记录程序开始时间
        long startTime = System.nanoTime();
        // 这里是要测试的代码块
        int sum = 0;
        for (int i = 1; i <= 10000000; i++) {
            sum += i;
        }
        // 记录程序结束时间
        long endTime = System.nanoTime();
        // 计算代码块运行时间
        long duration = endTime - startTime;
        // 输出运行时间
        System.out.println("程序运行时间：" + duration + "纳秒");
    }
}
```

## java.util.Date.getTime()

```java
public class PerformanceTimer {
    public static void main(String[] args) {
        // 记录程序开始时间
        Instant startTime = Instant.now();
        // 这里是要测试的代码块
        int sum = 0;
        for (int i = 1; i <= 10000000; i++) {
            sum += i;
        }
        // 记录程序结束时间
        Instant endTime = Instant.now();
        // 计算代码块运行时间
        long duration = Duration.between(startTime, endTime).toMillis();
        // 输出运行时间
        System.out.println("程序运行时间：" + duration + "毫秒");
    }
}
```

## java.time.Instant.now()

```java
public class PerformanceTimer {
    public static void main(String[] args) {
        // 记录程序开始时间
        long startTime = System.nanoTime();
        // 这里是要测试的代码块
        int sum = 0;
        for (int i = 1; i <= 10000000; i++) {
            sum += i;
        }
        // 记录程序结束时间
        long endTime = System.nanoTime();
        // 计算代码块运行时间
        long duration = (endTime - startTime) / 1000000;
        // 输出运行时间
        System.out.println("程序运行时间：" + duration + "毫秒");
    }
}
```

# Python代码段运行时间测量

Python中常用的测量代码运行时间的模块是timeit和time。其中，timeit模块可以更精确地测量小段代码的执行时间，而time模块则适合测量较长时间的代码执行时间。

如果要测量一段Python代码的运行时间，最好的方法是使用timeit.default_timer()函数来获取时间戳，并在代码运行前后调用该函数计算时间差，从而得到代码的执行时间。这种方法不仅精确度高，而且计算简单，适用于各种代码段的测量。

另外，如果需要更加精确地测量代码的执行时间，可以考虑使用time.process_time()函数，该函数可以测量进程的CPU时间，但需要注意的是，该函数只能测量CPU时间，不能测量I/O等等其他因素对代码运行时间的影响。

## time.clock()

Python的标准库手册推荐开发者在任何情况下尽量使用`time.clock()`。该方法只计算了程序运行CPU的时间，而不会计算等待I/O的时间，返回值是浮点数。

Windows 系统中，建议使用 time.clock()。

```python
import time


def my_function():
    # 待测试的代码
    result = 0
    for i in range(1000000):
        result += i
    return result


start_time = time.clock()
my_function()
end_time = time.clock()
elapsed_time_ms = (end_time - start_time) * 1000
print("平均每次运行时间为 {:.2f} 毫秒".format(elapsed_time_ms))
```

<font color="red">DeprecationWarning: time.clock has been deprecated in Python 3.3 and will be removed from Python 3.8: use time.perf_counter or time.process_time instead start_time = time.clock()</font>

从Python3.3开始，`time.clock()`被标记为过时；而从Python 3.8开始，`time.clock()`已被废弃。我们可以使用`time.perf_counter()`或`time.process_time()`函数代替`time.clock()`，返回值是以秒为单位的CPU时间，可以通过将其乘以1000来获得毫秒数。

```python
import time


def my_function():
    # 待测试的代码
    result = 0
    for i in range(1000000):
        result += i
    return result


start_time = time.process_time()
my_function()
end_time = time.process_time()
elapsed_time_ms = (end_time - start_time) * 1000
print("平均每次运行时间为 {:.2f} 毫秒".format(elapsed_time_ms))
```

## time.time()

由于time.time()返回的是从1970年1月1日零点到现在经过的秒数（即Unix时间戳），所以需要使用time.time()的小数部分来表示毫秒。

Unix 系统中，建议使用 time.time()。

以下是一份使用time.time()测量Python代码运行时间的完整代码示例：

```python
import time


def my_function():
    # 待测试的代码
    result = 0
    for i in range(1000000):
        result += i
    return result


start_time = time.time()
my_function()
end_time = time.time()
elapsed_time_ms = (end_time - start_time) * 1000
print("平均每次运行时间为 {:.2f} 毫秒".format(elapsed_time_ms))
```

其中start_time记录开始时间，end_time记录结束时间，两者相减得到运行时间，乘以1000得到毫秒数。最后输出运行时间的毫秒数。

## datetime.datetime.now()

使用datetime.datetime.now()并不是一个测量代码运行时间的合适方法。以下是一份基于datetime.datetime.now()的示例代码，但是其测量结果可能不够精确。

datetime.datetime.now()返回当前系统时间，但是因为计算机系统和资源的影响，它的精度可能会受到影响。另外，datetime.datetime.now()本身的执行也需要时间，因此它的计时可能包括了部分代码执行时间。所以，用datetime.datetime.now()测量代码运行时间可能不是最精确的方法。

datetime.datetime.now() 在不同操作系统和不同硬件上的表现可能会有差异，而 time.time() 不受操作系统和硬件的影响。

```python
import datetime


def my_function():
    # 待测试的代码
    result = 0
    for i in range(1000000):
        result += i
    return result


start_time = datetime.datetime.now()
my_function()
end_time = datetime.datetime.now()
elapsed_time_ms = (end_time - start_time).total_seconds() * 1000
print("平均每次运行时间为 {:.2f} 毫秒".format(elapsed_time_ms))
```

## timeit.default_timer()

```python
import timeit


def my_function():
    # 待测试的代码
    result = 0
    for i in range(1000000):
        result += i
    return result


start_time = timeit.default_timer()
my_function()
end_time = timeit.default_timer()
elapsed_time_ms = (end_time - start_time) * 1000
print("平均每次运行时间为 {:.2f} 毫秒".format(elapsed_time_ms))
```

timeit.default_timer()函数会自动选择最精确的计时器，有助于保证跨平台的精度。代码运行时间通过计算开始时间和结束时间的差，并将其转换为毫秒来计算。

# C代码运行时间测量

## clock()

测量步骤：
1. 引入time.h头文件并声明计时器变量和开始和结束时间。
2. 在要测量时间的代码块之前调用clock()函数记录开始时间。
3. 在要测量时间的代码块之后调用clock()函数记录结束时间，并计算代码执行时间。

```c
#include <stdio.h>
#include <time.h>

void cal_sum() {
    int result = 0;
    for (int i = 0; i < 10000000; i++) {
        result++;
    }
}

int main() {
    clock_t start_time, end_time;
    double elapsed_time;
    start_time = clock();
    cal_sum();
    end_time = clock();
    elapsed_time = ((double) (end_time - start_time)) / CLOCKS_PER_SEC;
    printf("代码执行时间：%.2f毫秒\n", elapsed_time * 1000);
    return 0;
}
```

在代码中，clock()函数返回程序自执行以来的处理器时钟周期数。CLOCKS_PER_SEC常量表示每秒钟的时钟周期数。因此，可以使用(end_time - start_time) / CLOCKS_PER_SEC计算代码执行的时间，单位是秒，然后乘以1000，将时间单位转换为毫秒。

# C++代码运行时间测量

在C++中，有多种方法可以测量代码的运行时间。以下是一些常见的方法：

1. 使用标准库chrono头文件中的高分辨率时钟函数，例如std::chrono::high_resolution_clock::now()和std::chrono::duration_caststd::chrono::milliseconds()，这可以精确地测量代码的执行时间，但需要编写较多代码。
2. 使用C++11中的std::chrono头文件中的函数，例如std::chrono::steady_clock::now()和std::chrono::duration_caststd::chrono::milliseconds()，这种方法与第一种方法类似，但只需要更少的代码。
3. 使用C++标准库头文件ctime中的clock()函数，该函数可以测量程序执行的CPU时间，但不是精确的墙上时间（wall-clock time），因此可能不适用于所有情况。
4. 使用操作系统提供的工具，例如Linux下的time命令或Windows下的Performance Monitor，这些工具可以测量整个程序的运行时间，但不会提供代码特定的细节信息。

最佳方法取决于具体情况，需要根据代码性质和测量要求来选择。
