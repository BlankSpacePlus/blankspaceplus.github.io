---
title: 软件可观察性
date: 2023-02-11 16:04:42
summary: 本文分享软件可观察性的相关内容。
tags:
- 软件质量
- 软件工程
categories:
- 软件工程
---

# 可观察性

测试允许工程师在系统构建和集成时进行验证，提高对业务的理解；而可观察性允许工程师更好地调试和在运行时进行验证。将可观察性与可视化结合，利用[Grafana](https://grafana.com)等工具，可以更好地开展工程实践。

部署上线程序并不是结束，在应用程序停止服务或被销毁前的整个生命周期内，工程师必须了解系统中正发生的事和曾发生过的事。软件的可观察性可以对此提供帮助。

推荐阅读：[Monitoring and Observability](https://copyconstruct.medium.com/monitoring-and-observability-8417d1952e1c)

监测和可观察性是不同的，但互补。监控最适合报告系统的整体运行状况，针对一些关键的业务和系统指标。可观察性为了提供对系统行为的细粒度理解以及丰富的上下文环境，非常适合调试功能。

监控、日志、跟踪提供了对软件系统的洞察力，体现了软件系统的可观察性。对系统的监控和观察主要是对应用程序、网络、机器开展的。为了更好地开展监控、日志、跟踪，必须在设计时就考虑到软件的可观察性。
- 监控可以几乎实时地观察某个系统，通常需要产生和收集临时的指标(Guage、Counter、Histogram、Meter、Timer)、数据和范围。监控收集的数据比较简单，无法对数据进行更深层次的聚合和挖掘。
- [日志](https://blankspace.blog.csdn.net/article/details/128977070)通常用来在将来的某个时间观察系统，例如故障发生之后。日志的语义比监控指标更加丰富，能够收集更多数据并进行数据挖掘。通过对日志的分析研究，不仅可以更好地了解系统过去的运行情况，还可能预测将来可能出现的问题。
- 跟踪(trace)会捕获请求在遍历分布式系统时的流转过程，并收集关键节点的元数据和时间耗费。关注的点包括API网关的流量、应用程序的请求处理、对数据库的查询处理等。

涉及可观察性的系统可以参考以下几方面：
- 设计之初就考虑到如何监控和记录日志，甚至将其添加到原型模板中。
- 确保创建的任何模块或微服务都能向上游系统公开所需的数据。
- 提供下游网络调用的上下文数据，比如正在调用哪个服务、正在调用的服务属于哪个应用程序。
- 各个团队公开所需的指标和日志数据并协商设计。

# 可观察性的工程实践

为了更好地暴露系统的核心指标，提高软件的可观察性，可以尝试以下内容：
- 始终暴露核心JVM的内部指标。这些指标主要包括堆外内存和堆内内存的使用情况、GC的运行频率、线程的详细信息(线程数、线程状态、线程占有的资源量)。
- 尝试暴露核心应用程序的技术细节，作为JVM内部指标的补充。这些技术细节包括某个内部队列的处理深度、内部缓存的统计信息、核心处理程序的吞吐量等。
- 报告错误和异常的详细情况。输出堆栈的注意以下事项：
    - 输出参数时，参数占位符用\[\]或者其它标点括起来，这样避免有些参数前后包含空格引发bug输出日志时不容易被发现。
    - 堆栈e不需要出现在占位符中，并且不要使用.toString()。
    - 不要使用Throwables.getStackTraceAsString(e)在log中输出堆栈。
    - 输出堆栈的实现代码：
        ```java
        void foo(String myParam1) {
            try {
                service.doMethod();
            } catch (Exception e) {
                logger.error("myParam1=[{}]", myParam1, e);
            }
        }
        ```
- 确保在设计实现基础设施和平台指标的时，开发团队和运维团队可以协同工作。平台内的每一层抽象都需要监控，这些抽象层可能包括应用程序框架、运行时Java容器、JVM、容器、容器调度器、虚拟化云硬件、物理基础设施。
- 与业务团队密切合作。
